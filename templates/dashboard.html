{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h2>Dashboard</h2>

{% if current_user.is_business %}
    <h3>Your Business</h3>
    <p>Business Name: {{ current_user.business.business_name }}</p>
    <p>Business Email: {{ current_user.business.business_email }}</p>
    <a href="{{ url_for('manage_clients') }}">Manage Clients</a>
{% else %}
    <a href="{{ url_for('register_business') }}">Register Your Business</a>
{% endif %}

<h3>Transaction Dashboard</h3>

<h4>Real-time Transaction Updates</h4>
<div id="real-time-updates"></div>

<h4>Recent Transactions</h4>
<table id="transactionTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Timestamp</th>
            <th>Amount</th>
            <th>Currency</th>
            <th>Status</th>
            <th>Debtor</th>
            <th>Creditor</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for transaction in transactions %}
        <tr>
            <td>{{ transaction.id }}</td>
            <td>{{ transaction.timestamp }}</td>
            <td>{{ transaction.amount }}</td>
            <td>{{ transaction.currency }}</td>
            <td>{{ transaction.status }}</td>
            <td>{{ transaction.debtor_name }}</td>
            <td>{{ transaction.creditor_name }}</td>
            <td><a href="{{ url_for('transaction_details', id=transaction.id) }}">View Details</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h3>Set Alert Thresholds</h3>
<form id="alertForm">
    <label for="amount_threshold">Amount Threshold:</label>
    <input type="number" id="amount_threshold" name="amount_threshold" step="0.01" required>
    <label for="currency">Currency:</label>
    <input type="text" id="currency" name="currency" required>
    <button type="submit">Set Alert</button>
</form>

<div id="alertMessages"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const updates = document.getElementById('real-time-updates');
    const transactionTable = document.getElementById('transactionTable').getElementsByTagName('tbody')[0];
    const alertForm = document.getElementById('alertForm');
    const alertMessages = document.getElementById('alertMessages');

    socket.on('connect', () => {
        console.log('Connected to server');
    });

    socket.on('transaction_update', (data) => {
        const newUpdate = document.createElement('div');
        newUpdate.textContent = `New transaction: ${data.amount} ${data.currency} - ${data.status}`;
        updates.prepend(newUpdate);

        const newRow = transactionTable.insertRow(0);
        newRow.innerHTML = `
            <td>${data.id}</td>
            <td>${data.timestamp}</td>
            <td>${data.amount}</td>
            <td>${data.currency}</td>
            <td>${data.status}</td>
            <td>${data.debtor_name}</td>
            <td>${data.creditor_name}</td>
            <td><a href="/transaction/${data.id}">View Details</a></td>
        `;
    });

    socket.on('alert_triggered', (data) => {
        const alertMessage = document.createElement('div');
        alertMessage.textContent = data.message;
        alertMessage.style.color = 'red';
        alertMessages.prepend(alertMessage);
    });

    alertForm.onsubmit = (e) => {
        e.preventDefault();
        const amountThreshold = document.getElementById('amount_threshold').value;
        const currency = document.getElementById('currency').value;

        socket.emit('set_alert', { amount_threshold: amountThreshold, currency: currency });
    };

    socket.on('alert_set', (data) => {
        if (data.status === 'success') {
            alert('Alert set successfully');
        } else {
            alert('Error setting alert');
        }
    });
</script>
{% endblock %}
